---
description: Unit tests decisions for the project
globs: __tests__/unit/**/*.spec.ts
alwaysApply: true
---

# Unit Tests
SÃ£o testes que verificam o comportamento de uma funÃ§Ã£o ou componente isoladamente.

## DefiniÃ§Ã£o Formal
Um **Teste UnitÃ¡rio** valida **uma Ãºnica unidade lÃ³gica**, de forma:
- DeterminÃ­stica
- Isolada
- Independente de UI, navegaÃ§Ã£o ou infraestrutura real

**Teste unitÃ¡rio NÃƒO renderiza telas.**

## Escopo Permitido para Testes UnitÃ¡rios
### Testes UnitÃ¡rios DEVEM cobrir:
#### Domain Layer
- Entities
- Value Objects
- Domain invariants
- Permission helpers
- Domain Errors
#### Application Layer
- Use Cases
- Fluxos vÃ¡lidos e invÃ¡lidos
- Regras de permissÃ£o
- Retornos `Result.ok` e `Result.fail`
- PropagaÃ§Ã£o correta de `DomainError`
#### Presentation (parcial)
- Hooks **sem renderizaÃ§Ã£o de UI**
- Helpers puros (formatadores, mappers)
- FunÃ§Ãµes determinÃ­sticas

**âœ… Allowed:**
- Testing Use Cases
- Testing hooks logic (without UI)
- Testing formatters, mappers, helpers
- âœ… Unit tests use `renderHook` for hooks
- âœ… Unit tests do NOT render JSX
- âœ… No production code should be changed to satisfy tests

## Para que servem?
Servem para:
- Testar funÃ§Ãµes e componentes isoladamente
- Testar lÃ³gica de negÃ³cio
- Testar validadores de formulÃ¡rios

---

## Escopo Proibido (NÃƒO NEGOCIÃVEL)
### Testes unitÃ¡rios **NÃƒO PODEM**:
- Renderizar `Screen` ou `Component`
- Usar `render()` do React Testing Library
- Usar `NavigationContainer`
- Usar ThemeProvider, SafeAreaProvider ou similares
- Acessar JSX ou layout
- Testar textos da UI
- Testar navegaÃ§Ã£o
- Testar efeitos visuais
- Testar integraÃ§Ã£o entre mÃºltiplas camadas

#### Se renderiza JSX â†’ **NÃƒO Ã© unit test**.

### **ğŸš« Unit tests MUST:**
- NOT render React Native components
- NOT use NavigationContainer
- NOT depend on ThemeProvider
- NOT assert UI strings

---

## Estrutura Recomendada
```
__tests__/unit/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ entities/
â”‚   â”œâ”€â”€ value-objects/
â”‚   â””â”€â”€ errors/
â”œâ”€â”€ application/
â”‚   â”œâ”€â”€ use-cases/
â”‚   â””â”€â”€ mappers/
â”œâ”€â”€ presentation/
â”‚   â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ formatters.spec.ts
â”‚       â””â”€â”€ masks.spec.ts
â””â”€â”€ main/
    â””â”€â”€ container.spec.ts
```
## Mock
### Regras de Mocking (CRÃTICAS)

#### Permitido
- Mockar **interfaces de repositÃ³rio**
- Mockar dependÃªncias de infraestrutura
- Mockar tempo, data e UUID

#### Proibido
- Mockar Domain Errors
- Mockar regras de negÃ³cio
- Mockar UI
- Mockar hooks dentro de unit tests
- Mockar o container para esconder falhas reais

#### Mocks devem refletir **contratos reais**, nunca comportamento desejado.

---

## Regras de AsserÃ§Ã£o

### Testes UnitÃ¡rios DEVEM:
- Validar retorno explÃ­cito (`Result.ok` / `Result.fail`)
- Validar dados de domÃ­nio
- Validar mensagens e cÃ³digos de `DomainError`
- Validar invariantes e exceÃ§Ãµes explÃ­citas

### Testes UnitÃ¡rios NÃƒO DEVEM:

- Validar strings de UI
- Validar copy textual
- Validar layout
- Validar side effects visuais

---

## IntegraÃ§Ã£o com ROP (Railway Oriented Programming)

- Todos os Use Cases retornam `Result<T, DomainError>`
- Testes unitÃ¡rios DEVEM validar:
  - Caminho de sucesso
  - Caminho de falha
- Ã‰ proibido:
  - LanÃ§ar exceÃ§Ãµes no teste para simular erro
  - Aceitar `unknown` como erro
  - Normalizar erros no teste

Exemplo correto:

```ts
const result = await useCase.execute(dto);

expect(result.isFailure()).toBe(true);
expect(result.getError()).toBeInstanceOf(DomainError);
```
---

## Regras de `Dependency Injection` nos Testes
Testes unitÃ¡rios:
- Instanciam `Use Cases` manualmente
- Injetam `dependÃªncias fake` ou `mockadas`
Testes unitÃ¡rios:
- **NÃƒO dependem** de React
- **NÃƒO dependem** de container.ts (exceto teste dedicado do container)

### Container Test (ExceÃ§Ã£o Controlada)
`src/main/container.ts` pode ter um teste unitÃ¡rio dedicado para verificar:
- ExportaÃ§Ã£o correta de instÃ¢ncias
- Wiring consistente

Este teste:
- NÃƒO renderiza UI ğŸš«
- NÃƒO executa Use Cases ğŸš«
- NÃƒO testa comportamento ğŸš«

### ğŸš¨ PROTOCOLO DE FALHA (OBRIGATÃ“RIO)

Quando um teste unitÃ¡rio falhar:
- Verificar se a regra de negÃ³cio mudou
- Verificar se o contrato do Use Case mudou
- Verificar se o mock viola o contrato
- Ajustar o teste para refletir o contrato atual

**ğŸš« Ã‰ proibido:**
- ğŸš« Alterar cÃ³digo de produÃ§Ã£o para satisfazer teste unitÃ¡rio
- ğŸš« Enfraquecer contratos para fazer teste passar

---

## **Consequences**
### BenefÃ­cios
- Testes rÃ¡pidos e determinÃ­sticos
- Alta confianÃ§a em regras de negÃ³cio
- Isolamento real de responsabilidades
- Facilidade de refatoraÃ§Ã£o de UI
- Base sÃ³lida para Integration e E2E tests

### Trade-offs
- Mais testes de integraÃ§Ã£o necessÃ¡rios
- Menos validaÃ§Ã£o visual em unit tests (intencional)

---

## Enforcement Rule

Este ADR Ã© obrigatÃ³rio para:
- Humanos
- AI tools
- Code agents
- Code reviews

#### Qualquer violaÃ§Ã£o deve ser tratada como erro arquitetural, nÃ£o como preferÃªncia de estilo.

Se houver dÃºvida:

**STOP. NÃƒO ADIVINHE. CRIE UM ADR OU PEÃ‡A CLARIFICAÃ‡ÃƒO.**

---

## Final Statement

### Unit Tests existem para proteger o CORE do sistema.
### UI e navegaÃ§Ã£o pertencem a Integration Tests.

**Este documento Ã© parte do contrato arquitetural do projeto.**