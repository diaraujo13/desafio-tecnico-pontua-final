---
description: Integration tests decisions for the project
globs: __tests__/integration/**/*.spec.ts
alwaysApply: true
---

# Integration Tests

### Defini√ß√£o Formal
Um **Teste de Integra√ß√£o** valida o **comportamento de uma Screen ou fluxo de UI**, incluindo:
- Renderiza√ß√£o
- Estados (loading / error / empty)
- Intera√ß√µes do usu√°rio
- Navega√ß√£o

**Testes de Integra√ß√£o N√ÉO validam regras de neg√≥cio.**

# Para que servem?
Servem para:
- Renderizar `Screens`
- Ver fluxo visual
- Testar `navigation`
- Testar Empty / Loading / Error states
- Validar intera√ß√£o do usu√°rio (`user interaction`), como cliques, preenchimentos de formul√°rios, etc.

**üö´ N√ÉO devem ser usados para testar: **
- Regra de neg√≥cio profunda
- Use Cases diretamente
- Formatos exatos de string
- Estrutura interna do JSX

## Regras
- Tests are stable, deterministic, and aligned with current UI behavior
- No production code is changed to ‚Äúmake tests pass‚Äù

---

## üö® NON-NEGOTIABLE RULES

### ‚ùå ABSOLUTELY FORBIDDEN

- Recreating or rewriting Use Cases
- Changing Domain, Application, or Infrastructure code
- Introducing new abstractions to satisfy tests
- Modifying architecture to accommodate tests
- Testing UI copy (exact strings)
- Testing JSX internal structure (parent.parent, etc.)
- Using implementation details as assertions
- Introducing error normalization or defensive logic
- Using `instanceof` in hooks or tests

If a test fails, you MUST fix the TEST, not the CODE.

Testes de integra√ß√£o **N√ÉO PODEM**:
- üö´ Testar regras de neg√≥cio
- üö´ Testar Use Cases diretamente
- üö´ Importar ou mockar `container.ts`
- üö´ Mockar reposit√≥rios ou infraestrutura
- üö´ Testar formato exato de strings
- üö´ Testar datas literais
- üö´ Testar estrutura interna de JSX (`parent.parent`)
- üö´ Alterar c√≥digo de produ√ß√£o para fazer teste passar

**Se um teste depende de texto literal ‚Üí **o teste est√° errado**.**

**üö´ DO NOT:**
- Assert exact text labels
- Assert date string literals
- Assert layout structure

--

## ‚úÖ ALLOWED ACTIONS

- Move test files to correct directories (e.g., __tests__/integration/presentation/screens/)
- Rename test files to reflect test type (e.g., *.int.spec.tsx)
- Rewrite assertions to test behavior instead of copy (e.g., getByText('Carregando detalhes...') -> getByTestId('vacation-details-loading'))
- Add `testID` attributes in Presentation layer ONLY
- Mock hooks (not Use Cases or repositories) in integration tests
- Update test mocks to match CURRENT behavior

## Escopo Permitido

Testes de integra√ß√£o DEVEM:

- Renderizar Screens completas
- Usar React Native Testing Library (RNTL)
- Usar `NavigationContainer` ou helper equivalente
- Mockar **hooks da Presentation**
- Validar:
  - estados visuais
  - intera√ß√µes
  - transi√ß√µes de navega√ß√£o


**‚úÖ Integration tests MUST:**
- Render the full `Screen`
- Use `renderWithNavigation`
- Mock hooks instead of mocking internal data (e.g., use `jest.mock('@/hooks/useAuth')`)
- Use `testID` for:
  - `loading`
  - `error`
  - `empty` state
  - `interactive` elements

**‚úÖ Assertions MUST focus on:**
- Visibility of states
- User interactions
- Navigation events

---

**‚ö†Ô∏è If `testIDs` do not exist:**
- Add them ONLY in the `Presentation` layer
- Keep them semantic and stable

---

## Estrutura Recomendada
```
__tests__/integration/
‚îú‚îÄ‚îÄ presentation/
‚îÇ   ‚îú‚îÄ‚îÄ screens/
```

**‚úÖ Renomear √© importante: *.int.spec.tsx**
- ‚úÖ Integration tests render full Screens/Components
- ‚úÖ Integration tests use testIDs for stable assertions
- ‚úÖ Integration tests mock hooks, not Use Cases

---

## Recomenda√ß√µes Arquiteturais
### Para telas complexas (Details, History, Dashboard, etc.):
- Sempre:
    - testID para estados (loading, error, empty)

    - testID para itens interativos
- Nunca:
    - Testar texto de label est√°tico
    - Testar estrutura interna de JSX
    - Depender de .parent.parent
### Loading e Error states: valide estado, n√£o copy
Fr√°gil:
```ts
getByText('Carregando detalhes...') // Fr√°gil
```
Est√°vel:
```ts
getByTestId('vacation-details-loading')
getByTestId('vacation-details-error')
```
---

## Regras de Mocking (CR√çTICAS)

### Permitido
- Mockar hooks da Presentation Layer
- Mockar retorno de hooks (data, loading, error)
- Simular callbacks (refetch, submit)

### Proibido
- Mockar Use Cases
- Mockar Domain
- Mockar Infrastructure
- Mockar Composition Root

Hooks s√£o o **boundary oficial** dos integration tests.

## Uso Obrigat√≥rio de `testID`

### Estados
```tsx
<View testID="screen-loading" />
<View testID="screen-error" />
<View testID="screen-empty" />
```

### testID deve ser:
- Sem√¢ntico
- Est√°vel
- Independente de layout

Texto de UI N√ÉO √© contrato.

--- 

## Regras de Asser√ß√£o
Testes de integra√ß√£o DEVEM:
	‚Ä¢	Verificar presen√ßa de estados via testID
	‚Ä¢	Verificar navega√ß√£o (mocked)
	‚Ä¢	Verificar efeitos de intera√ß√£o

Testes de integra√ß√£o N√ÉO DEVEM:
	‚Ä¢	Assertar texto literal
	‚Ä¢	Assertar estrutura de layout
	‚Ä¢	Assertar regras de neg√≥cio

--- 

## Como decidir rapidamente se um teste √© Unit ou Integration?
Fa√ßa essa pergunta:
- Esse teste renderiza JSX com layout?
    - **‚úÖ Se sim, √© um teste de integra√ß√£o.**
    - **‚ùå Se n√£o, √© um teste unit√°rio.**
- Esse teste quebra se mudar o texto da UI?
    - **‚úÖ Se sim, √© um teste de integra√ß√£o.**
    - **‚ùå Se n√£o, √© um teste unit√°rio.**

## Configura√ß√£o do Jest (opcional, mas recomendado)

```json
"scripts": {
  "test:unit": "jest __tests__/unit",
  "test:integration": "jest __tests__/integration",
  "test": "npm run test:unit && npm run test:integration"
}
```

## üß™ VERIFICATION CHECKLIST (MANDATORY)

Before finishing, ensure:
- All integration tests render `Screens` correctly
- No test depends on UI copy
- No test inspects `JSX` structure
- No production code was altered to satisfy tests
- `npm test:integration` passes consistently


## üß† DEBUGGING PROTOCOL (MANDATORY)

When a test **fails**:
	1.	Verify file exists and is imported correctly
	2.	Verify test expectations match **CURRENT** behavior
	3.	Verify mocks align with **hook contracts**
	4.	Only then modify the TEST minimally

If the cause is unclear:
- STOP
- Ask for clarification

## üéØ OUTPUT EXPECTATION
- Integration tests should be fast and reliable
- Stable test suite
- Tests that survive UI refactors
- Architecture remains untouched and enforceable
- Security to refactor UI without fear

---
## Enforcement Rule

Este ADR √© obrigat√≥rio para:
- Humanos
- AI tools
- Code agents
- Code reviews

Qualquer viola√ß√£o deve ser tratada como erro arquitetural.

---

## Final Statement

### Integration Tests validam comportamento do usu√°rio.
### Regras de neg√≥cio pertencem aos Unit Tests.