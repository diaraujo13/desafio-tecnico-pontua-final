# frozen_string_literal: true

Dir[File.join(__dir__, "helpers", "*.rb")].each { |f| require f }

default_platform :ios

XCODEPROJ = "ios/FeriasControlTemp.xcodeproj"
SCHEME = "FeriasControlTemp"

GRADLE_FILE = "./android/app/build.gradle"

# -------------------------
# CORE RELEASE LOGIC
# -------------------------
lane :release_core do
  # ensure_git_status_clean

  # 1Ô∏è‚É£ iOS versioning (FASTLANE DSL ‚Äî correto aqui)
  increment_build_number(xcodeproj: XCODEPROJ)

  increment_version_number(
    xcodeproj: XCODEPROJ,
    version_number: Versioning.version
  )

  # 2Ô∏è‚É£ Sync Android versionCode with iOS build number
  build_number = get_build_number(xcodeproj: XCODEPROJ)

  android_set_version_code(version_code: build_number, gradle_file: GRADLE_FILE)	

  android_set_version_name(version_name: Versioning.version, gradle_file: GRADLE_FILE)


  # 3Ô∏è‚É£ Tag
  tag = "v#{Versioning.version}+#{build_number}"

  # 4Ô∏è‚É£ Changelog
  changelog = changelog_from_git_commits(pretty: "- %s (%h)")
  UI.abort_with_message!("No changes to release") if changelog.strip.empty?

  Versioning.update_changelog!(tag: tag, changelog: changelog)

  # 5Ô∏è‚É£ Commit + tag + push
  commit_version_bump(
    message: "release: {tag} üöÄ",
    xcodeproj: XCODEPROJ,
    include: [
      "CHANGELOG.md",
      XCODEPROJ,
      GRADLE_FILE,
    ]
  )

  add_git_tag(tag: tag)
  push_to_git_remote
  push_git_tags
end

# -------------------------
# BUILD LANES
# -------------------------

lane :build_ios do
  build_app(
    xcodeproj: XCODEPROJ,
    scheme: SCHEME
  )
end

lane :build_android do
  UI.message("--- Building Android ü§ñ")
  gradle(
    task: "assembleRelease",
    version_name: Versioning.version,
    version_code: get_build_number(xcodeproj: XCODEPROJ),
    
    build_type: "Release"
  )

  UI.message("--- Android built successfully üéâ")
end

# -------------------------
# PUBLIC ENTRY POINTS
# -------------------------

lane :release do
  release_core
  build_ios
  build_android
end

lane :release_ios do

  release_core
  build_ios
end

lane :release_android do
  
  release_core
  build_android
end

