# frozen_string_literal: true

Dir[File.join(__dir__, "helpers", "*.rb")].each { |f| require f }

default_platform :ios

XCODEPROJ = "ios/FeriasControlTemp.xcodeproj"
SCHEME = "FeriasControlTemp"

# -------------------------
# CORE RELEASE LOGIC
# -------------------------

lane :release_core do |options|
  ensure_git_status_clean

  Versioning.bump!(xcodeproj: XCODEPROJ)

  build_number = get_build_number(xcodeproj: XCODEPROJ)
  version = Versioning.version
  tag = "v#{version}+#{build_number}"

  changelog = changelog_from_git_commits(pretty: "- %s (%h)")
  UI.abort_with_message!("Sem alterações significativas para lançar") if changelog.strip.empty?

  Versioning.update_changelog!(tag: tag, changelog: changelog)

  commit_version_bump(
    message: tag,
    xcodeproj: XCODEPROJ,
    include: [
      "CHANGELOG.md",
      "android/app/build.gradle"
    ]
  )

  add_git_tag(tag: tag)
  push_to_git_remote
  push_git_tags
end

# -------------------------
# PUBLIC ENTRY POINTS
# -------------------------

lane :release do
  release_core
  build_ios
  build_android
end

lane :release_ios do
  release_core
  build_ios
end

lane :release_android do
  release_core
  build_android
end

# -------------------------
# BUILD LANES
# -------------------------

lane :build_ios do
  build_app(
    xcodeproj: XCODEPROJ,
    scheme: SCHEME
  )
end

lane :build_android do
  Android.build
end