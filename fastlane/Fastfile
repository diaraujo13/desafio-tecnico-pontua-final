# frozen_string_literal: true

Dir[File.join(__dir__, "helpers", "*.rb")].each { |f| require f }

default_platform :ios

XCODEPROJ = "ios/FeriasControlTemp.xcodeproj"
SCHEME = "FeriasControlTemp"

# -------------------------
# CORE RELEASE LOGIC
# -------------------------

lane :release_core do |options|
  ensure_git_status_clean

  
  Versioning.bump!(xcodeproj: XCODEPROJ)

  build_number = get_build_number(xcodeproj: XCODEPROJ)
  version = Versioning.version
  tag = "v#{version}+#{build_number}"

  changelog = changelog_from_git_commits(pretty: "- %s (%h)")
  UI.abort_with_message!("‚ùå No significant changes to release") if changelog.strip.empty?

  UI.message("--- Updating changelog üìÑ")
  Versioning.update_changelog!(tag: tag, changelog: changelog)

  UI.message("--- Committing version bump üì¶")
  commit_version_bump(
    message: tag,
    xcodeproj: XCODEPROJ,
    include: [
      "CHANGELOG.md",
      "android/app/build.gradle"
    ]
  )

  UI.message("--- Adding git tag: #{tag}")
  add_git_tag(tag: tag)
  UI.message("--- Pushing git tag to remote")
  push_to_git_remote
  UI.message("--- Pushing git tags to remote")
  push_git_tags
  UI.message("Release complete! üéâ")
end

# -------------------------
# BUILD LANES
# -------------------------

lane :build_ios do
  build_app(
    xcodeproj: XCODEPROJ,
    scheme: SCHEME
  )
end

lane :build_android do
  UI.message("--- Building Android ü§ñ")
  Android.build
  UI.message("--- Android built successfully üéâ")
end

# -------------------------
# PUBLIC ENTRY POINTS
# -------------------------

lane :release do
  release_core
  build_ios
  build_android
end

lane :release_ios do
  release_core
  build_ios
end

lane :release_android do
  release_core
  build_android
end

